# Regular CI for testing linux_aarch64 and macosx_arm64 natively
# This only runs if cirrus is not building wheels. The rationale is that
# cibuildwheel also runs tests during the wheel build process, so there's no need
# to have duplication.

cirrus_wheels_linux_aarch64_task:
  arm_container:
    image: quay.io/pypa/manylinux2014_aarch64
    cpu: 4
    memory: 8G

    test_script: |
      git submodule update --init

      # We want to use a single version of python, there are lots
      # installed on this image. Make a symlink because the openblas setup
      # script refers to the python executable.
      ln -s $(which python3.10) python
      export PATH=$PWD:$PATH

      python -m pip install meson ninja numpy cython pybind11 pythran cython
      python -m pip install click rich_click doit pydevtool
      python -m pip install pytest pooch
      bash tools/wheels/cibw_before_build_linux.sh $PWD

      # need to place the meson location into PATH; it's placed in the python
      # bin directory, which isn't in PATH
      py_exe=$(readlink -f python)
      py_location=$(dirname $py_exe)
      export PATH=$py_location:$PATH

      python dev.py test
